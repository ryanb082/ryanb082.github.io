function generateCircleTexture(){var a=64,b=document.createElement("canvas");b.width=a,b.height=a;for(var c=b.getContext("2d"),d=a/2,e=a/2,f=a/2,g=1;g<33;g++)c.beginPath(),c.arc(d,e,f/2+g/2,0,2*Math.PI,!1),c.fillStyle="rgba(255, 255, 255, "+1/g+")",c.fill();return b}JumperMesh=function(){};var set_up_geo=!1;JumperMesh.prototype.initialize=function(a){var b={size:a&&a.size||512,color_base:a&&a.color_base||.5,color_breadth:a&&a.color_breath||.5};this.jumper_parameter=b,this.obj=new THREE.Object3D,this.size=a&&a.size||512;var c=new THREE.BufferGeometry;this.jumperGeo=c;for(var d=new Float32Array(3*this.size),e=new Float32Array(this.size),f=0;f<this.size;f++)e[f]=f+1;c.addAttribute("position",new THREE.BufferAttribute(d,3)),c.addAttribute("index_",new THREE.BufferAttribute(e,1));var g=new THREE.Texture(generateCircleTexture());g.needsUpdate=!0;var h=new THREE.TextureLoader,i={amplitude:{value:5},opacity:{value:1},color:{value:(new THREE.Color).setHSL(Math.random()*b.color_breadth-.5*b.color_breadth+b.color_base,1,.6)},time:{value:0},texture:{type:"t",value:g}};this.uniforms=i;var j="uniform float amplitude;varying float vIndex;varying float distance;uniform float time;attribute float index_;void main() {   vIndex      =   index_;   vec4 pos_gl =   modelViewMatrix * vec4( position.x, position.y, position.z , 1 );   distance    =   -pos_gl.z *0.0003;   gl_Position =   projectionMatrix * pos_gl;   gl_PointSize =  pow(position.z,1.4);}",k="uniform vec3 color;uniform float opacity;uniform float time;uniform sampler2D texture;uniform sampler2D noise;varying float vIndex;varying float distance;void main() {  vec4 circle =  texture2D( texture, gl_PointCoord );   gl_FragColor = vec4( color,  clamp( sin( 3.1415 * 1.0 + 3.1415 * (vIndex / "+this.size+".0* 0.5 )  + time *0.02 * 3.1415), 0.0,1.5) )   * circle; }",l=new THREE.ShaderMaterial({uniforms:i,vertexShader:j,fragmentShader:k,blending:THREE.NormalBlending,depthTest:!1,transparent:!0,sizeAttenuation:!0});this.jumper=new THREE.Points(c,l),this.jumper.frustumCulled=!1,this.vector0=new THREE.Vector3(0,0,0),this.obj.add(this.jumper),this.base_speed=.5,this.active=!1,this.light=new THREE.PointLight(i.color.value,1.5,5),this.light.position.y-=50,this.obj.add(this.light)},JumperMesh.prototype.setUp=function(a,b){this.place1=a.clone(),this.place2=b.clone(),this.light.position.copy(b),this.light.position.z=5,this.uniforms.time.value=0,this.speed=(1*Math.random()+.5)*this.base_speed,this.active=!0;var c=new THREE.Vector3,d=Math.min(a.distanceTo(b),6),e=this.size;for(Math.random();e--;){var g=c.lerpVectors(a,b,e/(this.size-1));this.jumperGeo.attributes.position.array[3*e]=g.x,this.jumperGeo.attributes.position.array[3*e+1]=g.y,this.jumperGeo.attributes.position.array[3*e+2]=g.z,this.jumperGeo.attributes.position.array[3*e+2]+=Math.sin(Math.PI*(e/(this.size-1)))*d}this.jumper.geometry.attributes.position.needsUpdate=!0},JumperMesh.prototype.animate=function(){this.active&&this.uniforms.time.value<100?(this.uniforms.time.value+=this.speed,this.light.position.lerp(this.place1,Math.pow(.005*this.uniforms.time.value,2))):this.active&&(this.active=!1)},JumperMesh.prototype.reset=function(){this.active=!1,this.uniforms.time.value=100},JumperMesh.prototype.adjustColors=function(a,b){this.jumper_parameter.color_base=a,this.jumper_parameter.color_breadth=b,this.uniforms.color.value.setHSL(Math.random()*this.jumper_parameter.color_breadth-.5*this.jumper_parameter.color_breadth+this.jumper_parameter.color_base,1,.6),this.light.color.copy(this.uniforms.color.value)};var UsaJumpers=function(){};UsaJumpers.prototype.setUp=function(a){function B(a){for(var b=k.length;b--;)k[b].adjustColors(E.j_c_base,E.j_c_breadth);console.log(E.j_c_base,E.j_c_breadth)}function G(a){console.log(),n.material.color.setStyle(E.base_color)}function H(){p=new dat.GUI,p.addColor(E,"base_color").onChange(G),p.add(E,"reset"),p.add(E,"run"),p.add(E,"pause"),p.add(E,"j_c_breadth",0,1,.01).onChange(B),p.add(E,"j_c_base",0,1,.01).onChange(B)}function I(){d=document.getElementById(a.container_name||"full-model-container"),b=new THREE.Scene,i=new THREE.PerspectiveCamera(35,d.clientWidth/d.clientHeight,.1,2500),i.position.set(0,0,63),i.setFocalLength(35),cameraInitPosition=i.position.clone(),b.add(i);var e;cities=[],k=[];var f=this,l=new THREE.Mesh(new THREE.CylinderGeometry(.02,.05,.2,32),new THREE.MeshPhongMaterial({emissive:4626}));l.geometry.rotateX(.5*Math.PI),l.geometry.translate(0,0,.1),function(){var b=new XMLHttpRequest;b.open("GET",a.json_usa_cities,!0),b.onload=function(c){if(4===b.readyState)if(200===b.status){e=JSON.parse(b.responseText),console.log(a.json_usa_cities+" response :"+b.status),console.log("new data total "+e.length),f.marks_count=e.length;for(var d=f.marks_count;d--;){var g=e[d],h=l.clone();h.material=h.material.clone(),h.material.color=new THREE.Color,h.material.color.setHSL(g.population/8405837*.5+.5,1,.5),h.scale.set(1+4*g.population/8405837,1+4*g.population/8405837,1+4*g.population/8405837),h.data=g,h.position.set(g.longitude+96.3,g.latitude-36,0),cities.push(h),n.add(h),d||--D||a.ready_callback()}}else console.error(b.statusText)},b.onerror=function(a){console.error(b.statusText)},b.send(null)}();var o=new THREE.TextureLoader;n=new THREE.Mesh(new THREE.PlaneGeometry(61.5,31.5,32,32),new THREE.MeshPhongMaterial({specularMap:o.load("js/textures/specular.jpg"),displacementScale:.1,bumpScale:.1,transparent:!0,color:16777215,side:THREE.DoubleSide})),o.load("js/textures/diffuse-2.png",function(b){b.generateMipmaps=!1,b.magFilter=THREE.LinearFilter,b.minFilter=THREE.LinearFilter,b.needsUpdate=!0,n.material.map=b,n.material.needsUpdate=!0,--D||a.ready_callback()}),b.add(n);for(var p=a.jumpers_count;p--;)j=new JumperMesh,j.initialize({size:512}),k.push(j),n.add(j.obj);q=new THREE.AmbientLight(1118481),b.add(q),r=new THREE.SpotLight(16777215,1,70,.45*Math.PI),r.position.set(-1,10,25),b.add(r),r.lookAt(n),s=new THREE.SpotLight(16777198,.5,50,.25*Math.PI),s.position.set(45,0,15),b.add(s),s.lookAt(n),c=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),c.setClearColor(8947848,0),c.setPixelRatio(window.devicePixelRatio||1),g=d.clientWidth,h=d.clientHeight,c.sortObjects=!1,c.setSize(g,h),d.appendChild(c.domElement),c.gammaInput=!0,c.gammaOutput=!0}function x(){J++;for(var a=k.length;a--;)if(J%(100+50*a)==0&&!k[a].active){var b=cities[Math.floor(Math.random()*cities.length)],c=cities[Math.floor(Math.random()*cities.length)];j=k[a],j.setUp(b.position.clone(),c.position.clone())}for(var a=k.length;a--;)k[a].animate();if(!L){K++;var d=Math.pow(Math.sin(.0051*K),2);n.rotation.x=-d*Math.PI*.35,i.position.z=cameraInitPosition.z+20*d,(d>.999||d<.001)&&(L=!0,M=10)}L&&(M--||(L=!1)),f=requestAnimationFrame(x),w()}function w(){c.render(b,i)}function v(){for(var a=k.length;a--;)k[a].reset()}function y(){f?(cancelAnimationFrame(f),f=void 0,console.warn("pausing")):console.warn("already")}function A(){f?console.warn("already running"):(x(),console.warn("runnin"))}function N(){var a=d.clientWidth,b=d.clientHeight;i.aspect=a/b,i.updateProjectionMatrix(),c.setSize(a,b),e||w()}var b,c,d,e,f,g,h,i,j,k,n,p,e,q,r,s,v,w,x,y,A,B,D=(a.ready_callback,2),E={base_color:"#110f11",reset:v,pause:y,run:A,j_c_base:.76,j_c_breadth:.25};I(),G(),B(),a.using_gui&&H();var M,J=0,K=0,L=!1;window.addEventListener("resize",N,!1),this.author=function(){return"@tinotibaldo"},this.toogleAutoRotate=function(){toogle_auto_rotate()},this.reset=function(){v()},this.redraw=function(){N()},this.pause=function(){y()},this.run=function(){A()},this.start=function(){x()}};var start_loading;window.onload=function(){start_loading()},start_loading=function(){var a,b="usa-jumpers-container",c="spinner-container",d=function(){document.getElementById(b).style.visibility="visible",document.getElementById(c).style.display="none",a.start()};Number(window.location.search.substr(1));a=new UsaJumpers;var g=(document.getElementById(b),{texture_usa:"./textures/USA-example.png",json_usa_cities:"js/cities.JSON",container_name:b,autoRotate_enable:!1,ready_callback:d,using_gui:!1,jumpers_count:4});a.setUp(g),a.redraw()};